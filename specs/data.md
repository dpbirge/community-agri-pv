# Data Organization Specification

**Document Version**: 2.0
**Date**: 2026-02-12
**Status**: Updated to match actual codebase

## Overview

This document defines the data folder structure for the community agri-PV model. The organization follows the three-layer computational architecture (Layer 1: Pre-computation, Layer 2: Design, Layer 3: Simulation) and distinguishes between time-series data (temporally indexed) and parameter data (static characteristics).

## Design Principles

1. **Layer-aligned structure**: Data organization mirrors the computational layers
2. **Time-series vs parameters**: Fundamentally different data types in separate locations
3. **Filename suffixes**: Use `-toy`, `-research`, or `-real` to indicate data source/quality
4. **Embedded metadata**: All data files include header comments with source, units, dependencies, logic
5. **Human-readable formats**: CSV for all data files
6. **Iterative improvement**: Start with toy data, progressively replace with researched estimates, then empirical/simulated data
7. **Code stability**: Structure matches how code will access data (no rewiring as we build)

## Top-Level Structure

```
data/
├── precomputed/        # Layer 1 outputs (pre-computed physical libraries)
├── parameters/         # Static parameters (Layer 2 design inputs)
├── prices/            # Historical price time-series (Layer 2 economic inputs)
├── scripts/           # Data generation scripts (Layer 1)
└── README.md          # Data folder overview and usage guide
```

Scenario configurations live in:
```
settings/
├── data_registry.yaml # Central registry mapping data keys to file paths
└── settings.yaml      # Active scenario configuration
```

Policy implementations live in the source code:
```
src/policies/          # Policy classes (water, energy, crop, economic, market, food)
```

Simulation outputs live in:
```
results/               # Layer 3 outputs (not in data/)
```

---

## Detailed Structure

### `data/precomputed/` - Layer 1 Outputs

Pre-computed physical libraries generated by Layer 1. These are indexed time-series and lookup tables that Layer 3 retrieves during simulation. All files are normalized (per-unit capacity or per-area) and deterministic given their inputs.

```
precomputed/
├── weather/
│   ├── daily_weather_scenario_001-toy.csv
│   ├── daily_weather_scenario_001-research.csv  # 15-year Sinai synthetic data (2010-2024)
│   └── TEMPLATE_weather.csv
│
├── pv_power/
│   └── pv_normalized_kwh_per_kw_daily-toy.csv   # Indexed by weather_scenario_id, date
│
├── wind_power/
│   └── wind_normalized_kwh_per_kw_daily-toy.csv  # Indexed by weather_scenario_id, date
│
├── irrigation_demand/
│   ├── irrigation_m3_per_ha_tomato-toy.csv       # Indexed by weather_scenario_id, planting_date, crop_day
│   ├── irrigation_m3_per_ha_potato-toy.csv
│   ├── irrigation_m3_per_ha_onion-toy.csv
│   ├── irrigation_m3_per_ha_kale-toy.csv
│   └── irrigation_m3_per_ha_cucumber-toy.csv
│
├── crop_yields/
│   ├── yield_kg_per_ha_tomato-toy.csv            # Indexed by weather_scenario_id, planting_date
│   ├── yield_kg_per_ha_potato-toy.csv
│   ├── yield_kg_per_ha_onion-toy.csv
│   ├── yield_kg_per_ha_kale-toy.csv
│   └── yield_kg_per_ha_cucumber-toy.csv
│
├── water_treatment/
│   └── treatment_kwh_per_m3-toy.csv              # Indexed by salinity_level (brackish groundwater)
│
├── household/
│   ├── household_energy_kwh_per_day-toy.csv      # Community household electricity demand
│   └── household_water_m3_per_day-toy.csv        # Community household water demand
│
├── community_buildings/
│   ├── community_buildings_energy_kwh_per_day-toy.csv  # Community/industrial building electricity demand
│   └── community_buildings_water_m3_per_day-toy.csv    # Community/industrial building water demand
│
└── microclimate/
    ├── pv_shade_adjustments-toy.csv              # Temperature and irradiance adjustments under agri-PV
    └── pv_shade_adjustments-research.csv
```

**Registry keys** (from `data_registry.yaml`):
- `weather.daily` → weather data
- `power.pv`, `power.wind` → normalized power output
- `irrigation.<crop>` → per-crop irrigation demand
- `yields.<crop>` → per-crop yield potential
- `water_treatment.energy` → treatment energy lookup
- `household.energy`, `household.water` → household demand
- `community_buildings.energy`, `community_buildings.water` → building demand
- `microclimate.pv_shade` → agri-PV microclimate effects

#### Weather File Format Example

```csv
# SOURCE: Synthetic weather generator based on hot arid climate assumptions
# DATE: 2026-02-02
# DESCRIPTION: Daily weather data for scenario 001 - baseline hot arid year
# LOCATION: Sinai Peninsula, Egypt (~28°N, 34°E)
# UNITS: temp_max_c (Celsius), temp_min_c (Celsius), solar_irradiance_kwh_m2 (kWh/m²/day), wind_speed_ms (m/s), precip_mm (mm/day)
# LOGIC: Synthetic generation with seasonal patterns - low rainfall, high temps, high solar
# DEPENDENCIES: None (base input)
date,temp_max_c,temp_min_c,solar_irradiance_kwh_m2,wind_speed_ms,precip_mm,weather_scenario_id
2024-01-01,28,15,5.2,3.5,0.0,001
2024-01-02,29,16,5.4,3.2,0.0,001
2024-01-03,27,14,5.1,4.1,0.0,001
```

#### PV Power File Format Example

```csv
# SOURCE: Computed from weather data using simplified PV model
# DATE: 2026-02-06
# DESCRIPTION: Normalized daily PV power output per kW of installed capacity for three agri-PV density variants (low/medium/high ground coverage)
# UNITS: date=YYYY-MM-DD, density_variant=text, kwh_per_kw_per_day=kWh/kW/day, capacity_factor=dimensionless(0-1)
# LOGIC: PV output = solar_irradiance * tilt_factor(1.05) * temp_factor * (1-system_losses). Temp factor uses cell temp model: T_cell = T_avg + 25C + density_adjustment. Temperature coefficient = -0.4%/C from 25C reference. System losses = 15%.
# DEPENDENCIES: data/precomputed/weather/daily_weather_scenario_001-toy.csv
# ASSUMPTIONS: Fixed-tilt 28deg south-facing panels. Module efficiency ~19%. High density panels run 2C cooler (shading effect), low density run 2C hotter. All panels receive full irradiance (panels above crops, not shaded by each other).
weather_scenario_id,date,density_variant,kwh_per_kw_per_day,capacity_factor
001,2010-01-01,low,3.4202,0.1425
001,2010-01-01,medium,3.4499,0.1437
001,2010-01-01,high,3.4796,0.145
```

#### Irrigation Demand File Format Example

```csv
# SOURCE: FAO Penman-Monteith ET0 calculation + crop coefficients
# DATE: 2026-02-02
# DESCRIPTION: Daily irrigation demand for tomatoes per hectare
# CROP: Tomato (Solanum lycopersicum)
# UNITS: m3_per_ha_per_day (cubic meters per hectare per day), calendar_date (YYYY-MM-DD), etc_mm (mm/day)
# LOGIC: Irrigation = ET0 * Kc * 10 (to convert mm to m³/ha)
# DEPENDENCIES: precomputed/weather/daily_weather_scenario_001-toy.csv, parameters/crops/crop_coefficients-toy.csv
# GROWTH_STAGES: initial (0-20 days), development (21-40), mid (41-100), late (101-130)
weather_scenario_id,planting_date,crop_day,calendar_date,growth_stage,kc,et0_mm,etc_mm,irrigation_m3_per_ha_per_day
001,2010-01-01,1,2010-01-01,initial,0.60,5.2,3.12,34.7
001,2010-01-01,2,2010-01-02,initial,0.60,5.4,3.24,36.0
001,2010-01-01,25,2010-01-25,development,0.85,5.8,4.93,54.8
001,2010-01-01,50,2010-02-19,mid,1.15,6.2,7.13,79.2
001,2010-01-01,110,2010-04-20,late,0.80,5.5,4.40,48.9
```

---

### `data/parameters/` - Static Parameters

Static characteristics and lookup tables used by Layer 2 for design and by Layer 3 for simulation. These define physical properties, costs, and constraints but are not time-indexed.

```
parameters/
├── crops/
│   ├── crop_coefficients-toy.csv              # Kc by growth stage, root depth, growing season length
│   ├── crop_coefficients-research.csv         # FAO-56 based coefficients for Sinai climate
│   ├── growth_stages-toy.csv                  # Duration and water sensitivity by crop and growth stage
│   ├── yield_response_factors-toy.csv         # K_y values for FAO-33 water deficit yield formula
│   ├── yield_response_factors-research.csv    # FAO-33 K_y values from literature
│   ├── handling_loss_rates-toy.csv            # Loss rates by crop and processing pathway
│   ├── handling_loss_rates-research.csv       # Research-grade post-harvest loss rates
│   ├── planting_windows-research.csv          # Valid planting date ranges per crop for Sinai
│   ├── microclimate_yield_effects-research.csv # PV shade effects on crop yield by density
│   ├── processing_specs-toy.csv               # Energy, labor, weight loss, value-add by processing type
│   ├── processing_specs-research.csv          # Research-grade processing specifications
│   ├── storage_spoilage_rates-toy.csv                 # Shelf life days by crop and product type (FIFO tracking)
│   └── TEMPLATE_crop_coefficients.csv         # Template for creating new crop coefficient files
│
├── equipment/
│   ├── pv_systems-toy.csv                     # Module efficiency, temp coefficient, degradation, lifespan
│   ├── batteries-toy.csv                      # Capacity, charge/discharge efficiency, cycle life, DOD limits
│   ├── wind_turbines-toy.csv                  # Power curve parameters, cut-in/cut-out speeds, capacity
│   ├── wind_turbines-research.csv             # Research-grade specs: Bergey Excel 10, Eocycle EO25, Endurance E-3120
│   ├── water_treatment-toy.csv                # Desalination energy per m³, capacity, capex, opex
│   ├── water_treatment-research.csv           # Research-grade BWRO treatment parameters
│   ├── wells-toy.csv                          # Well depth, flow rate, pump efficiency
│   ├── generators-toy.csv                     # Diesel generator specs, fuel coefficients
│   ├── irrigation_systems-toy.csv             # Irrigation system efficiency by type
│   ├── processing_equipment-toy.csv           # Drying, canning equipment capacity, energy, costs
│   ├── fresh_packaging-toy.csv                # Fresh packaging line specs
│   ├── processed_packaging-toy.csv            # Processed product packaging specs
│   ├── storage_systems-toy.csv                # Storage capacity and costs by type
│   └── equipment_failure_rates-toy.csv        # MTBF, repair cost, downtime duration by equipment type
│
├── labor/
│   ├── labor_requirements-toy.csv             # Hours per hectare or per kg by activity type
│   ├── labor_wages-toy.csv                    # Hourly wage by worker category (community, external)
│   └── labor_wages-research.csv               # Egyptian agricultural wage data
│
├── community/
│   ├── farm_profiles-toy.csv                  # Farm size, yield factor, starting capital by profile type
│   ├── housing_energy_water-toy.csv           # Per-household energy and water demand
│   ├── land_allocation-toy.csv                # Total area, farmland, housing, buffer zones, solar arrays
│   └── community_buildings_energy_water-toy.csv # Energy/water demand for community and industrial buildings
│
├── economic/
│   └── financing_profiles-toy.csv                 # Financing category parameters (loan terms, rates, multipliers)
└── costs/
    ├── capital_costs-toy.csv                  # Capex by equipment type ($/kW, $/kWh, $/m³/day, etc.)
    ├── capital_costs-research.csv             # Research-grade capital costs (model-specific wind turbine pricing)
    ├── operating_costs-toy.csv                # Opex rates by equipment type ($/kW/year, etc.)
    └── operating_costs-research.csv           # Research-grade O&M costs (wind: Bergey measured, NREL benchmarks)
```

**Registry keys** (from `data_registry.yaml`):
- `crops.*` → crop parameter files (coefficients, growth_stages, processing_specs, yield_response_factors, handling_loss_rates, planting_windows, storage_spoilage_rates)
- `equipment.*` → equipment parameter files (pv_systems, wind_turbines, batteries, processing, failure_rates, wells, irrigation_systems, storage_systems, generators, fresh_packaging, processed_packaging)
- `water_treatment.equipment` → water treatment equipment specs
- `labor.*` → labor requirements and wages
- `community.*` → farm profiles, land allocation, housing, buildings
- `economic.*` → financing profiles
- `costs.*` → capital and operating costs

#### Crop Coefficients File Format Example

```csv
# SOURCE: FAO Irrigation and Drainage Paper 56 (FAO-56)
# DATE: 2026-02-02
# DESCRIPTION: Crop coefficients and growing characteristics
# UNITS: kc (dimensionless), root_depth_m (meters), season_length_days (days)
# LOGIC: Kc values from FAO-56 Table 12, adjusted for hot arid climate
# DEPENDENCIES: None (reference data)
# NOTES: Kc_initial for dry soil after planting, Kc_mid at full canopy, Kc_end at harvest
crop_name,kc_initial,kc_mid,kc_end,root_depth_m,season_length_days,water_stress_sensitivity
tomato,0.60,1.15,0.80,0.7,135,high
potato,0.50,1.15,0.75,0.4,120,high
onion,0.70,1.05,0.75,0.3,150,high
kale,0.70,1.00,0.95,0.4,90,medium
cucumber,0.60,1.00,0.75,0.7,105,high
```

#### Equipment Failure Rates File Format Example

```csv
# SOURCE: Industry reliability data and manufacturer specifications (toy estimates)
# DATE: 2026-02-02
# DESCRIPTION: Equipment failure rates and repair parameters
# UNITS: mtbf_hours (mean time between failures), repair_cost_usd (USD), downtime_days (days)
# LOGIC: Exponential failure distribution with MTBF, repair cost as percentage of capex
# DEPENDENCIES: parameters/costs/capital_costs-toy.csv
# NOTES: MTBF values are conservative estimates for hot, dusty environments
equipment_type,mtbf_hours,failure_probability_per_year,repair_cost_usd,downtime_days,maintenance_interval_days
pv_inverter,50000,0.175,1500,2,90
battery_system,30000,0.292,5000,3,180
water_pump,40000,0.219,800,1,30
treatment_plant,60000,0.146,3000,5,60
processing_equipment,35000,0.251,1200,2,30
```

---

### `data/prices/` - Historical Price Time-Series

Time-series price data for crops, processed goods, and inputs. These support both historical Monte Carlo runs (resampling actual sequences) and synthetic price generation (modulated by historical volatility).

```
prices/
├── crops/
│   ├── historical_tomato_prices-toy.csv
│   ├── historical_potato_prices-toy.csv
│   ├── historical_onion_prices-toy.csv
│   ├── historical_kale_prices-toy.csv
│   ├── historical_cucumber_prices-toy.csv
│   ├── historical_tomato_prices-research.csv    # FAO/USDA-based Egyptian farmgate prices
│   ├── historical_potato_prices-research.csv
│   ├── historical_onion_prices-research.csv
│   ├── historical_kale_prices-research.csv
│   └── historical_cucumber_prices-research.csv
│
├── processed/
│   ├── historical_canned_cucumber_prices-toy.csv
│   ├── historical_canned_kale_prices-toy.csv
│   ├── historical_canned_onion_prices-toy.csv
│   ├── historical_canned_potato_prices-toy.csv
│   ├── historical_canned_tomato_prices-toy.csv
│   ├── historical_dried_cucumber_prices-toy.csv
│   ├── historical_dried_kale_prices-toy.csv
│   ├── historical_dried_onion_prices-toy.csv
│   ├── historical_dried_potato_prices-toy.csv
│   ├── historical_dried_tomato_prices-toy.csv
│   ├── historical_packaged_cucumber_prices-toy.csv
│   ├── historical_packaged_kale_prices-toy.csv
│   ├── historical_packaged_onion_prices-toy.csv
│   ├── historical_packaged_potato_prices-toy.csv
│   ├── historical_packaged_tomato_prices-toy.csv
│   └── historical_pickled_cucumber_prices-toy.csv
│
├── electricity/
│   ├── historical_grid_electricity_prices-toy.csv               # Subsidized agricultural tariffs
│   ├── historical_grid_electricity_prices-research.csv          # Egyptian agricultural tariffs (researched)
│   ├── historical_grid_electricity_prices_unsubsidized-toy.csv  # Unsubsidized commercial tariffs
│   └── historical_grid_electricity_prices_unsubsidized-research.csv  # Egyptian unsubsidized tariffs (researched)
│
├── inputs/
│   └── historical_fertilizer_costs-toy.csv     # Fertilizer cost per hectare
│
├── water/
│   ├── historical_municipal_water_prices-toy.csv
│   └── historical_municipal_water_prices-research.csv  # Egyptian HCWW tiered pricing
│
└── diesel/
    ├── historical_diesel_prices-toy.csv
    └── historical_diesel_prices-research.csv   # Egyptian diesel prices
```

**Registry keys** (from `data_registry.yaml`):
- `prices_crops.<crop>` → fresh crop price files
- `prices_processed.<product>` → processed product price files
- `prices_utilities.electricity_subsidized` → subsidized grid prices
- `prices_utilities.electricity_unsubsidized` → unsubsidized grid prices
- `prices_utilities.municipal_water` → municipal water prices
- `prices_utilities.diesel` → diesel fuel prices

**Electricity pricing note:** The simulation supports dual pricing regimes (subsidized/unsubsidized) for both agricultural and community consumers. The registry maps to separate files for each regime. See `structure.md` Pricing Configuration and `simulation_flow.md` Section 4 for resolution logic.

#### Crop Price File Format Example

```csv
# SOURCE: USDA National Agricultural Statistics Service (toy approximation)
# DATE: 2026-02-02
# DESCRIPTION: Historical wholesale tomato prices with seasonal variation
# UNITS: usd_per_kg (USD per kilogram)
# LOGIC: Synthetic data with realistic seasonality - low at harvest peaks, high in off-season
# DEPENDENCIES: None (market data)
# SEASONALITY: Prices lowest June-August (peak harvest), highest December-February
# VOLATILITY: Year-to-year CV approximately 25%, driven by regional supply shocks
date,usd_per_kg,season,market_condition
2020-01-01,2.80,winter,high
2020-02-01,2.75,winter,high
2020-03-01,2.50,spring,medium
2020-06-01,1.80,summer,low
2020-09-01,2.20,fall,medium
2020-12-01,2.90,winter,high
2021-01-01,2.85,winter,high
```

---

### `data/scripts/` - Data Generation Scripts

Layer 1 pre-computation scripts that generate the precomputed libraries and parameter files.

```
scripts/
├── generate_weather_data.py              # 15-year synthetic weather for Sinai (~28N, 34E)
├── generate_crop_parameters.py           # Crop coefficients, growth stages, processing specs
├── generate_irrigation_and_yields.py     # FAO Penman-Monteith irrigation demand and yield calculations
├── generate_power_data.py                # PV and wind normalized power output
├── generate_price_data.py                # Historical price time-series (crop, processed, electricity, water, diesel, fertilizer)
├── generate_household_demand.py          # Household energy and water demand
└── generate_community_building_demand.py # Community and industrial building energy and water demand
```

---

## Metadata Standards

Every CSV file must include a header comment block with the following fields:

- **SOURCE**: Where the data came from (paper citation, database, generation method)
- **DATE**: When the file was created or last updated
- **DESCRIPTION**: What the data represents
- **UNITS**: Units for each numeric column
- **LOGIC**: Calculation method or generation algorithm
- **DEPENDENCIES**: Other files this data depends on
- **ASSUMPTIONS**: Key assumptions made in generating the data
- **NOTES**: Any additional context

For toy data, SOURCE should clearly state it is synthetic/approximated and reference any assumptions or target ranges used.

---

## Settings Organization

Scenario and policy configurations live outside `data/` in the `settings/` folder:

### `settings/` - Scenario Configurations

The settings folder contains the scenario YAML file and the central data registry. Scenarios define infrastructure, community, policies, and are loaded by `src/settings/loader.py` into structured dataclasses.

**Current scenario file**: `settings/settings.yaml`

The scenario YAML structure uses `_system` suffixes for infrastructure sections (`water_system`, `energy_system`, `food_processing_system`) and references policies by name. See `structure.md` for the full schema.

**Data registry**: `settings/data_registry.yaml` maps logical data keys (e.g., `weather.daily`, `irrigation.tomato`) to file paths. The `SimulationDataLoader` uses this registry to resolve data at runtime. The registry supports alternative file comments (e.g., `# alt: ...`) for easy switching between toy and research data.

### `src/policies/` - Policy Implementations

Policy classes live in `src/policies/` with a consistent pattern: context dataclass (input), decision/allocation dataclass (output), base class, concrete implementations, and a registry with factory function.

```
src/policies/
├── __init__.py               # Exports all policies, registries, and factory functions
├── water_policies.py         # 6 water allocation policies (integrated)
├── food_policies.py          # 4 food processing allocation policies (integrated)
├── energy_policies.py        # 3 energy dispatch policies (not yet integrated)
├── crop_policies.py          # 3 irrigation management policies (not yet integrated)
├── economic_policies.py      # 4 financial management policies (not yet integrated)
└── market_policies.py        # 3 sale timing policies (not yet integrated)
```

Policies are selected by name in the scenario YAML and instantiated during scenario loading. See `structure.md` Section 3 for the full policy catalog and integration status.

---

## Data Quality Evolution Path

All datasets follow this iterative improvement path:

1. **Toy data** (`-toy` suffix): Generated synthetic data with reasonable assumptions
   - Purpose: Enable model development and testing
   - Quality: Order-of-magnitude correct, captures key patterns
   - Example: Weather with generic hot/arid seasonality

2. **Research data** (`-research` suffix): Literature-based values grounded in published studies
   - Purpose: Improve realism using FAO, USDA, Egyptian government data, and academic sources
   - Quality: Representative of real-world ranges for the Sinai/Egypt context
   - Example: FAO crop coefficients, Egyptian HCWW water tariffs, Egyptian agricultural wages

3. **Real data** (`-real` suffix): Empirical measurements or validated simulations
   - Purpose: Location-specific accuracy for production runs
   - Quality: Actual historical data or high-fidelity simulations
   - Example: Historical weather from specific location, actual market price data

> **Note on suffix convention:** The codebase uses `-research` for literature-grounded data, reserving `-toy` for purely synthetic values. The `-real` suffix is reserved for future empirical data. The `SimulationDataLoader` has a `use_research_prices` flag to prefer `-research` files when available.

---

## Dataset Inventory

This table tracks all datasets in the model. Status columns: T = toy exists, R = research exists.

### Precomputed (Layer 1 outputs)

| Dataset | T | R | Registry Key | Notes |
|---|---|---|---|---|
| Weather time-series | x | x | `weather.daily` | 15-year Sinai synthetic (2010-2024) |
| PV power normalized output | x | | `power.pv` | |
| Wind power normalized output | x | | `power.wind` | |
| Crop irrigation demand (5 crops) | x | | `irrigation.<crop>` | Tomato, potato, onion, kale, cucumber |
| Crop yields (5 crops) | x | | `yields.<crop>` | |
| Water treatment energy curves | x | | `water_treatment.energy` | Categorical salinity lookup |
| Microclimate adjustments under agri-PV | x | x | `microclimate.pv_shade` | |
| Household energy demand | x | | `household.energy` | Community household electricity |
| Household water demand | x | | `household.water` | Community household water |
| Community buildings energy demand | x | | `community_buildings.energy` | Offices, storage, industrial |
| Community buildings water demand | x | | `community_buildings.water` | Facility water needs |

### Parameters (Static characteristics)

| Dataset | T | R | Registry Key | Notes |
|---|---|---|---|---|
| Crop coefficients (Kc, growth stages) | x | x | `crops.coefficients` | FAO-56 based |
| Growth stages (durations, sensitivity) | x | | `crops.growth_stages` | |
| Yield response factors (K_y) | x | x | `crops.yield_response_factors` | FAO-33 water deficit |
| Post-harvest losses | x | x | `crops.handling_loss_rates` | By crop and pathway |
| Planting windows | | x | `crops.planting_windows` | Valid planting dates for Sinai |
| Crop processing specifications | x | x | `crops.processing_specs` | Weight loss, value-add, energy |
| Microclimate yield effects | | x | `crops.microclimate_yield_effects` | PV shade effects by density |
| Spoilage rates / shelf life | x | | `crops.storage_spoilage_rates` | FIFO tranche tracking |
| PV system specifications | x | | `equipment.pv_systems` | |
| Battery specifications | x | | `equipment.batteries` | |
| Wind turbine specifications | x | x | `equipment.wind_turbines` | Bergey, Eocycle, Endurance |
| Water treatment specifications | x | x | `water_treatment.equipment` | BWRO parameters |
| Well specifications | x | | `equipment.wells` | |
| Generator specifications | x | | `equipment.generators` | |
| Irrigation system specifications | x | | `equipment.irrigation_systems` | |
| Fresh packaging equipment | x | | `equipment.fresh_packaging` | |
| Processed packaging equipment | x | | `equipment.processed_packaging` | |
| Storage systems | x | | `equipment.storage_systems` | |
| Processing equipment | x | | `equipment.processing` | |
| Equipment failure rates | x | | `equipment.failure_rates` | |
| Labor requirements | x | | `labor.requirements` | |
| Labor wages | x | x | `labor.wages` | Egyptian agricultural rates |
| Farm profiles | x | | `community.farm_profiles` | |
| Community housing energy/water | x | | `community.housing` | |
| Land allocation | x | | `community.land_allocation` | |
| Community buildings energy/water | x | | `community.buildings` | Offices, storage, industrial |
| Capital costs | x | x | `costs.capital` | |
| Operating costs | x | x | `costs.operating` | |
| Financing profiles | x | | `economic.financing_profiles` | Loan terms, rates, multipliers |
| Aquifer parameters | | | (documentation) | Markdown reference doc |
| Water source metadata | | | (config) | YAML metadata file |

### Price Time-Series

| Dataset | T | R | Registry Key | Notes |
|---|---|---|---|---|
| Historical crop prices (5 crops) | x | x | `prices_crops.<crop>` | FAO/USDA-based Egyptian farmgate |
| Historical processed product prices (16 products) | x | | `prices_processed.<product>` | All crop-product combinations: 5 packaged, 5 canned, 4 dried, 1 pickled, 1 additional |
| Historical electricity prices (subsidized) | x | x | `prices_utilities.electricity_subsidized` | Egyptian agricultural tariffs |
| Historical electricity prices (unsubsidized) | x | x | `prices_utilities.electricity_unsubsidized` | Commercial/industrial tariffs |
| Historical municipal water prices | x | x | `prices_utilities.municipal_water` | Egyptian HCWW tiered pricing |
| Historical diesel prices | x | x | `prices_utilities.diesel` | Egyptian diesel prices |
| Historical fertilizer costs | x | | `prices_inputs.fertilizer_costs` | Per-hectare aggregate |

### Settings (Configuration)

| Component | Status | Notes |
|---|---|---|
| Scenario YAML (`settings.yaml`) | Complete | Full infrastructure, community, policy selections |
| Data registry (`data_registry.yaml`) | Complete | Maps all data keys to file paths |
| Policy implementations (6 domains) | Complete | 23 total policies in `src/policies/` |
| Monte Carlo configuration | In code | Default CVs in `monte_carlo.py`, overridable at runtime |

### Data Generation Scripts

| Script | Output | Notes |
|---|---|---|
| `generate_weather_data.py` | Weather time-series | 15-year Sinai synthetic |
| `generate_crop_parameters.py` | Crop coefficients, growth stages, processing specs | FAO-56 based |
| `generate_irrigation_and_yields.py` | Irrigation demand, crop yields | FAO Penman-Monteith |
| `generate_power_data.py` | PV and wind normalized output | |
| `generate_price_data.py` | All price time-series | Crop, processed, electricity, water, diesel, fertilizer |
| `generate_household_demand.py` | Household energy and water demand | |
| `generate_community_building_demand.py` | Community building energy and water demand | |

---

## Data Requirements by Simulation Subsystem

This section maps which data files feed into each subsystem, linking `data/` files to the calculations in `calculations.md`, the policies in `policies.md`, and the simulation flow in `simulation_flow.md`.

### Water Subsystem

**Daily loop steps:** Crop policy (Step 1) → Water policy (Step 2) → Household water (Step 2b)

| Data Needed | Source File | Used By |
|---|---|---|
| Irrigation demand per crop | `precomputed/irrigation_demand/irrigation_m3_per_ha_<crop>-toy.csv` | Crop policy context (`base_demand_m3`) |
| Treatment energy per m3 | `precomputed/water_treatment/treatment_kwh_per_m3-toy.csv` | Water policy context (`treatment_kwh_per_m3`) |
| Well specifications | `parameters/equipment/wells-toy.csv` | System constraints (`max_groundwater_m3`) |
| Water treatment specs | `parameters/equipment/water_treatment-toy.csv` | System constraints (`max_treatment_m3`) |
| Municipal water prices | `prices/water/historical_municipal_water_prices-*.csv` | Water policy context (`municipal_price_per_m3`) |
| Grid electricity prices | `prices/electricity/historical_grid_electricity_prices-*.csv` | Water policy context (`energy_price_per_kwh`) |
| Household water demand | `precomputed/household/household_water_m3_per_day-toy.csv` | Step 2b household allocation |
| Community buildings water | `precomputed/community_buildings/community_buildings_water_m3_per_day-toy.csv` | Step 2b facility allocation |
| Housing parameters | `parameters/community/housing_energy_water-toy.csv` | `calculate_household_demand()` |
| Community buildings params | `parameters/community/community_buildings_energy_water-toy.csv` | Building demand calculation |
| Aquifer parameters | `docs/research/aquifer_parameters.md` | Aquifer drawdown feedback (yearly) |

### Energy Subsystem

**Daily loop step:** Energy policy and dispatch (Step 3)

| Data Needed | Source File | Used By |
|---|---|---|
| PV normalized output | `precomputed/pv_power/pv_normalized_kwh_per_kw_daily-toy.csv` | `dispatch_energy()` (`pv_available_kwh`) |
| Wind normalized output | `precomputed/wind_power/wind_normalized_kwh_per_kw_daily-toy.csv` | `dispatch_energy()` (`wind_available_kwh`) |
| PV system specs | `parameters/equipment/pv_systems-toy.csv` | Degradation rate, temp coefficient |
| Wind turbine specs | `parameters/equipment/wind_turbines-*.csv` | Hub height, power curve |
| Battery specs | `parameters/equipment/batteries-toy.csv` | Capacity, charge/discharge efficiency, SOC limits |
| Generator specs | `parameters/equipment/generators-toy.csv` | Capacity, fuel coefficients |
| Diesel prices | `prices/diesel/historical_diesel_prices-*.csv` | Generator fuel cost |
| Grid electricity prices | `prices/electricity/historical_grid_electricity_prices*-*.csv` | Grid import/export cost |
| Household energy demand | `precomputed/household/household_energy_kwh_per_day-toy.csv` | E_household component |
| Community buildings energy | `precomputed/community_buildings/community_buildings_energy_kwh_per_day-toy.csv` | E_other component |
| Microclimate adjustments | `precomputed/microclimate/pv_shade_adjustments-*.csv` | Shading factor for PV output |

### Crop and Harvest Subsystem

**Daily loop step:** Crop policy (Step 1), harvest yield calculation (Step 4)

| Data Needed | Source File | Used By |
|---|---|---|
| Crop coefficients | `parameters/crops/crop_coefficients-*.csv` | Kc values, growth stage durations |
| Growth stages | `parameters/crops/growth_stages-toy.csv` | Stage durations, water sensitivity |
| Yield response factors | `parameters/crops/yield_response_factors-*.csv` | K_y for FAO-33 yield formula |
| Planting windows | `parameters/crops/planting_windows-research.csv` | Valid planting dates |
| Post-harvest losses | `parameters/crops/handling_loss_rates-*.csv` | Loss rates by pathway |
| Crop yields (potential) | `precomputed/crop_yields/yield_kg_per_ha_<crop>-toy.csv` | Y_potential for harvest calculation |
| Microclimate yield effects | `parameters/crops/microclimate_yield_effects-research.csv` | PV shade yield modification |
| Weather data | `precomputed/weather/daily_weather_scenario_001-*.csv` | Temperature for crop/weather policies |

### Food Processing and Market Subsystem

**Daily loop steps:** Food processing (Step 4) → Forced sales (Step 4b) → Market policy (Step 5)

| Data Needed | Source File | Used By |
|---|---|---|
| Processing specifications | `parameters/crops/processing_specs-*.csv` | Weight loss, energy per kg, value-add |
| Processing equipment | `parameters/equipment/processing_equipment-toy.csv` | Capacity limits for clipping |
| Fresh packaging specs | `parameters/equipment/fresh_packaging-toy.csv` | Fresh line throughput |
| Processed packaging specs | `parameters/equipment/processed_packaging-toy.csv` | Packaging capacity |
| Storage systems | `parameters/equipment/storage_systems-toy.csv` | Storage capacity by type |
| Spoilage rates | `parameters/crops/storage_spoilage_rates-toy.csv` | Shelf life for FIFO tracking |
| Fresh crop prices | `prices/crops/historical_<crop>_prices-toy.csv` | Market policy context, food policy trigger |
| Processed product prices | `prices/processed/historical_<product>_prices-toy.csv` | Revenue calculation |

### Economic Subsystem

**Periodic steps:** Economic policy (Step 6, monthly), Daily accounting (Step 7), Yearly boundary (Step 8)

| Data Needed | Source File | Used By |
|---|---|---|
| Financing profiles | `parameters/economic/financing_profiles-toy.csv` | Debt service, cost multipliers |
| Capital costs | `parameters/costs/capital_costs-*.csv` | Infrastructure CAPEX |
| Operating costs | `parameters/costs/operating_costs-*.csv` | Infrastructure OPEX |
| Farm profiles | `parameters/community/farm_profiles-toy.csv` | Starting capital, yield factor |
| Land allocation | `parameters/community/land_allocation-toy.csv` | Area for cost allocation |
| Labor requirements | `parameters/labor/labor_requirements-toy.csv` | Labor cost calculation |
| Labor wages | `parameters/labor/labor_wages-*.csv` | Wage rates by activity |
| Fertilizer costs | `prices/inputs/historical_fertilizer_costs-toy.csv` | Input cost tracking |
| Equipment failure rates | `parameters/equipment/equipment_failure_rates-toy.csv` | Stochastic events (future) |

---

## Usage Notes

### For Model Development

1. **Start with toy data**: Generate minimal synthetic datasets to get Layer 3 running
2. **Focus on structure first**: Ensure file formats and indexing work correctly
3. **Add complexity incrementally**: Start with 1 crop, 1 weather scenario, 1 year
4. **Validate at each step**: Check that data flows correctly through layers before expanding

### For Data Research

1. **Prioritize high-sensitivity parameters**: Focus real data research on weather, crop yields, prices
2. **Document sources meticulously**: Embed all metadata in file headers
3. **Version control everything**: Track data quality improvements over time
4. **Create data validation scripts**: Automated checks for units, ranges, consistency

### For Scenario Design

1. **Use descriptive names**: `high_solar_low_battery.yaml` is better than `scenario_03.yaml`
2. **Document rationale**: Explain why infrastructure/policy choices were made
3. **Reference policies by name**: Don't embed policy logic in scenario files
4. **Test incrementally**: Start with deterministic runs before Monte Carlo

---

## Project Specifications Summary

### Location and Context
- **Location**: Sinai Peninsula along the Red Sea, Egypt
- **Climate**: Hot, arid desert requiring year-round irrigation
- **Cropping**: Multiple growing seasons per year (2-3 seasons for fast crops, 1 for slower crops)
- **Community scale**: 20 farms, 500 hectares total farmland, ~150 population

### Crop Selection
1. **Tomato** -- Multiple seasons/year, high value, export potential
2. **Potato** -- Single season, staple crop, storage crop
3. **Onion** -- Single season, staple crop, excellent storage
4. **Kale** -- Multiple seasons, nutritious, heat-tolerant leafy green
5. **Cucumber** -- Multiple seasons, high export value, processing potential

### Time Series Parameters
- **Weather data**: Single scenario, 15 years (2010-2024) of synthetic data for Sinai Red Sea climate
- **Price data**: 10 years (2015-2024) where available from real sources, extend with synthetic
- **Alignment**: Real data where available, toy data to fill gaps

### Infrastructure Specifications

#### Irrigation
- **Technology**: Drip irrigation only (90% efficiency)
- **Design**: Extensible for future irrigation methods

#### Solar PV (Agri-PV)
- **Configuration**: Fixed-tilt, ~28 angle (mid-Sinai latitude)
- **Optimization**: Fall-spring peak output, reduced summer performance
- **Panel height**: 3 meters above crops
- **Density variants**:
  - High: 80% ground coverage (heavy shade)
  - Medium: 50% coverage (balanced)
  - Low: 30% coverage (light shade, maximum crop light)
- **Type**: Single panel type, three installation densities

#### Wind Turbines
- **Variants**: 3 representative microgrid-scale turbine sizes
- **Differentiation**: Different performance in varying wind conditions, different cost-benefit ratios
- **Focus**: Normalized power curves and costs

#### Diesel Generator
- **Baseline**: 100 kW unit (irrigation pumps + critical building loads)
- **Backup purpose**: Pumps and some building backup (not full community power)
- **Scalability**: Can add more units if needed

#### Water Systems
- **Sources**: Brackish groundwater (onsite desalination) + municipal water
- **Brackish salinity levels**: Model all three types with cost data
  - Light: 1,000-3,000 ppm TDS
  - Moderate: 3,000-10,000 ppm TDS
  - Heavy: 10,000+ ppm TDS
- **Baseline salinity**: 5,000 ppm TDS (moderate) for default scenarios

### Processing and Storage

#### Processing Types
1. **Fresh sales**: Local markets (no processing)
2. **Packaged fresh**: Export to Europe (cleaning, packaging, cold chain)
3. **Canned**: Preservation processing
4. **Dried/dehydrated**: Vegetable powder and dried products
5. **NO freezing**: Not modeled

#### Processing Capacity
- **Sizing basis**: Derived from peak harvest rates (e.g., drying sized to handle 10% of peak daily harvest)
- **Note**: Actual capacities determined by farm yields, not arbitrary values

### Economic Parameters

#### Currency
- **Primary**: USD for all model calculations
- **Documentation**: Original currency (EGP, EUR) documented with conversion rates and sources
- **Conversion**: Track exchange rates used for transparency

#### Labor
- **Wages**: Egyptian agricultural wages by activity type
- **Categories**:
  - Field work (planting, weeding, harvesting, irrigation)
  - Management and administration
  - Canning and processing operations
  - Packaging operations
  - Maintenance and logistics
- **Availability**: Unlimited labor (not a constraint), but costs tracked

#### Pricing
- **Crop prices**: Global food prices (FAO, USDA) as baseline
- **Export prices**: European market prices + shipping cost estimates
- **Electricity**: Egyptian agricultural electricity tariffs (subsidized and unsubsidized regimes)
- **Water**: Egyptian municipal water prices (tiered and flat regimes)
- **Diesel**: Egyptian diesel prices

### Energy and Water Loads

#### Community Energy Demand
Model includes:
- **Irrigation pumps**: Primary load
- **Water treatment**: Desalination energy
- **Housing**: Small AC units, refrigerators, lighting (~150 people)
- **Processing facilities**: Canning, drying, packaging operations
- **Community buildings**: Offices, storage facilities, industrial buildings
- **Farm equipment**: Hand-operated machinery (no tractors)

#### Community Water Demand
Model includes:
- **Irrigation**: Primary demand
- **Domestic**: Housing and sanitation (~150 people)
- **Processing**: Washing, canning, cleaning operations
- **Facilities**: Community building needs

### Grid Reliability
- **Modeling**: Price variations only (no brownouts/outages in initial model)
- **Tariff structure**: Dual agricultural/community regimes, subsidized and unsubsidized options
- **Future**: Can add outage modeling in later phases

### Monte Carlo Configuration
- **Location**: Implemented in `src/simulation/monte_carlo.py`
- **Status**: Functional -- stochastic price/yield sampling with configurable CVs and N runs
- **Sensitivity**: Implemented in `src/simulation/sensitivity.py` -- one-at-a-time analysis
- **Future**: Weather scenario variation, equipment failure events, correlation structure

---

## References

- Community Farm Model Specifications: `specs/overview.md`
- Configuration Schema: `specs/structure.md`
- Calculation Methodologies: `specs/calculations.md`
- Policy Specifications: `specs/policies.md`
- Simulation Flow: `specs/simulation_flow.md`
- Metrics and Reporting: `specs/metrics_and_reporting.md`
- Data Catalog: `specs/data.md`
- FAO Irrigation and Drainage Paper 56: http://www.fao.org/3/x0490e/x0490e00.htm
- NREL PV Performance Data: https://www.nrel.gov/grid/solar-resource/
